#!/bin/bash
#FILEBASE=${1##*/}

n=$(mktemp -u); FILEBASE=${n#*.}

#echo $FILEBASE
#WORKINGPATH=/isms/group/tmus/web-demo/${FILEBASE}
WORKINGPATH=$(pwd)/${FILEBASE}
mkdir $WORKINGPATH
chmod a+rwx $WORKINGPATH
#echo $WORKINGPATH
#echo $PATH
old_dir=$(pwd)
cd $WORKINGPATH
cp ../$1 page.jpg
#chmod a+rwx page.jpg
#/opt/local/bin/convert page.jpg page.tiff
convert page.jpg page.tiff
#echo "Converted to tiff OK"
#/usr/local/bin/aruspix-cmdline -m models page.tiff
aruspix-cmdline -m /home/mas01tc/emo_search/server_client/models/ page.tiff 2>/dev/null
#echo "Passed through Aruspix OK" >> log;
unzip page.axz page.mei  >> log
echo "Extracted MEI OK" >> log
#/opt/local/bin/gawk -f ../parse_mei_to_diat_int_str.awk page.mei > page.txt
echo ">"$1 > page.txt
gawk -f ../scripts/parse_mei_to_diat_int_str.awk page.mei >> page.txt
cat page.txt; echo >> log

file=$1
name=$(basename ${file%.*})
#echo >> log
timestamp=`date --rfc-3339=seconds`
echo $timestamp": Generating MAWs for "$1":" >> log
maw -a 'PROT' -i page.txt -o $name".maw" -k 4 -K 8 2>> log
awk '{printf("%s ",$0)}' $name".maw" > $name"_oneline.maw" 
cat $name"_oneline.maw" >> log
echo >> log

cd $old_dir


