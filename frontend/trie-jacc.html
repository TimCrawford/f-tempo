<html>
	<head>
		<script src="trie.js" type="text/javascript" ></script>
		<script src='jquery.min.js'></script>
		<script src='jquery.zoom.js'></script>
		<style>
			.zoom img {
				display: block;
			}
			.zoom img::selection { background-color: transparent; }

			.tooltip {
				position: relative;
				display: inline-block;
				border-bottom: 1px dotted black;
			}

			.tooltip .tooltiptext {
				visibility: hidden;
				width: 90px;
		/*		background-color: #555; */
				background-color: lightcoral;
				color: #fff;
				font-size: 70%;
				text-align: center;
				border-radius: 6px;
				padding: 5px 0;
				position: absolute;
				z-index: 1;
				bottom: 125%;
				left: 50%;
				margin-left: -60px;
				opacity: 0;
				transition: opacity 1s;
			}

			.tooltip .tooltiptext::after {
				content: "";
				position: absolute;
				top: 120%;
				left: 50%;
				margin-left: -5px;
		/*		
				border-width: 5px;
				border-style: solid;
				border-color: #555 transparent transparent transparent;
		*/
			}

			.tooltip:hover .tooltiptext {
				visibility: visible;
				opacity: 1;
			}

			.id_list_name, .table_body {
				font-size: 30%;
				color: blue;
				height: 10px;
			}
			
			select {
				height:10px;
				line-height:9px;
				background:#f4f4f4;
			} 
			
			.drop_downs option {
				height: 10px;
				font-size: 30%;
			}
			
			#database_panel, #query_panel {
				font-size: 75%;
			}
			thead, #q_page_display, #res_display_div, #res_table_label {
				font-size: 75%;
				font-weight: bold;
			}
			
			#messages {
				color: red;
			}
			#database_name {
				font-size: 50%;
				color: blue;
			}
		</style>
		
		<script  type="text/javascript" >

			// Global variables:
			var trie_loaded = false;
			var lines = [];
			var database_data = "";
			var query_id="";

		//	Number of results to display; should be set in the user-interface:
			var num_res_disp = 20;

			var last_res_disp = 0; // last result to be displayed  NB FIXME - doesn't always work!!
			var last_query_id = ""; // the last query, to return to NB FIXME (should be an array of queries)
			var db_name ="";
			var highlighted_result_row = 0;
			
			var UID = "";
			var can_store_UID = false;
			if (storageAvailable('localStorage')) {
			  // Yippee! We can use localStorage awesomeness
			  console.log("Local Storage available!")
			  if(!localStorage.getItem("userID")) {
				  console.log("Setting new UID!")
				  localStorage.setItem("userID",uniqueID());
				  UID = localStorage.getItem("userID");
			  }
			  else UID = localStorage.getItem("userID");
			  can_store_UID = true;
			}
			else {
			  // Too bad, no localStorage for us - just get a new UID
				  console.log("No Local Storage available! Setting new unique ID")
				  UID = uniqueID();
			}
			console.log("UID is "+UID);

			function get_ng_len() {
				var txt;
				var ng_len = prompt("Enter ngram length:", "6");
				if($.isNumeric(ng_len)) {
					if ((ng_len != null) && (ng_len != "")) {
						txt = "You asked for ngrams " + ng_len + " long!";
						if((parseInt(ng_len)>2)&&(parseInt(ng_len)<16)) {
						  document.getElementById("messages").innerHTML = txt;
						  return ng_len;
						}
						else alert("Too short!");
					}
				}
				else alert("Not a number!");
				return false;
			}
			
			function load_arbitrary_database() {
				var ng_len = get_ng_len();
				if((ng_len>2)&&(ng_len<16)) {
					db_name ="ngrams/emo_"+ng_len+"grams.txt";
					console.log("Trying to load "+db_name);
					get_and_load_database(db_name);
				}
				else alert("Loading database failed!");
			}
			
			function load_full_maws_database() {
					db_name ="maw_4-8_sameline.txt";
					console.log("Trying to load "+db_name);
					get_and_load_database(db_name);
			}
			
			function get_and_load_database(the_db){
				hide_query_panel();
				hide_display_panel();
				document.getElementById("database_name").innerHTML = "<small>Loading database ...</small>";
				if(!the_db) the_db = document.getElementById("maw_data").value;
				db_name = the_db;
				console.log("database: "+the_db);
				$.ajax({
					type: "GET",
					url: "get_database.php",
					data: {database: the_db},
					success: function(data) {
						load_data(data);
						document.getElementById("database_name").innerHTML = "<i>"+db_name+"</i> loaded";
						show_query_panel();
					}
				});
			}
			
			// array containing objects holding number of MAWs for each id in database
			// for use in normalisation elsewhere
			var word_tot = [];
/*
			function get_word_tot(id) {
				for(var i=0,the_length=word_tot.length;i<=the_length;i++) {
					if(word_tot[i].id == id) return word_tot[i].num;
				}
				return false;
			}
*/
			function load_data(data) {
				document.getElementById("database_name").innerHTML = "Loading database ...";
			//clear text-entry boxes:
				document.getElementById("queryText").innerHTML = "";
				document.getElementById("idText").innerHTML = "";
				
				lines = data.split("\n");
				console.log(lines.length+" lines to read");
				for(i in lines) {
					bits = lines[i].split(/[ ,]+/).filter(Boolean);
					if (typeof bits[0] !== 'undefined') {
						var id = "";
						// chop initial ">" from fasta format
						if(bits[0].charAt(0)==">") id = bits[0].substring(1); 
						else id = bits[0]; 
				/*
						word_tot[i] = {}; 
						word_tot[i].num = bits.length - 1;
						word_tot[i].id = id; 
				*/
						word_tot[id] = bits.length - 1;

						for(j=1;j<bits.length;j++) {
							trie.id_add(bits[j],id);	
						}
					}
					else {
						console.log(i+" lines of data loaded!")
						console.log('trie count words is: ', trie.countWords()); 
						document.getElementById("messages").innerHTML = "";
					}
				}
				trie_loaded = true;
	//			save_trie_json();
			}

			function save_trie_json() {
				var trie_json = JSON.stringify(trie);
				var json_chunk = JSON.stringify(trie).substring(0,250);
				console.log("JSON begins: \n"+json_chunk);
				console.log("Saving trie for "+"emo_data/databases/"+db_name+" as JSON ...");
				json_name = "emo_data/databases/"+db_name.substring(0,db_name.lastIndexOf(".")) + ".json";
				
				$.ajax({
					type: "POST",
					url: "save_json_database.php",
					data: {json_db: json_name, json: trie_json},
					success: function(result) {
						console.log("Saving JSON to "+json_name+"...");
						console.log(result);
					}
				});
				
			}
			function load_trie_json() {
			}
			
			var jaccard = true;
			
			function searchTrie(complete) {
				if(!trie_loaded) {
					alert("Please choose and load database!");
					return;
				}
				else {
					// save the previous query_id in case user wants to return with left-arrow				
					last_query_id = query_id;
					
					// wipe last result display:
					load_result_image(false);
					hide_result_table();
					
					var x = "";
					if(complete) x = document.getElementById("queryText").value;
					else x = get_query_from_id(document.getElementById("idText").value);
					if(!x) {
						document.getElementById("messages").innerHTML="<p style='color:red'>ID not found!</p>";
						x_wds = complete? document.getElementById("idText").value.split : document.getElementById("idText").value.split(" ");
						log_search_problem(x_wds[0],"ID not found", db_name);
						document.getElementById("q_page_display").innerHTML="";
						document.getElementById("img_display").innerHTML="";
						return false;
					}
					else {					
						show_display_panel();
						var queryArray = x.split(/\s/);
						var id = query_id = queryArray[0];
						if(id.substring(0,1)==">") query_id = query_id.substring(1);
						wds_in_q = queryArray.length-1
						if(wds_in_q < 6) {
							document.getElementById("messages").innerHTML = "Not enough data in query. Try again!";
							log_search_problem(query_id,"Not enough words in query ("+wds_in_q+")", db_name);
							document.getElementById("img_display").innerHTML="";
							return;
						}
						document.getElementById("messages").innerHTML=wds_in_q+" words in query";
					}
					load_page_query(query_id);
					var words = [];
					for(i=1,qa_length=queryArray.length;i<qa_length;i++) {
						if(queryArray[i].length) {
							words.push(queryArray[i]);
						}
					}
					var res = false;
					var score = [];
					for(w in words) {
						res = trie.getIDs(words[w]);
						if(res != false) {
							var item = false;
							for(let item of res.values()) {
								if (!score[item])  {
				//					score[item] = new Array();
									score[item] = {};
									score[item].id = item;
									score[item].num = 0;
								}
								score[item].num++;
							}
						}
					}
				}
				var result_num = 0;
				var scores_pruned = [];
				for(var g in score) {
					if(score[g].num > 1) {
			//			scores_pruned[result_num] = new Array();
						scores_pruned[result_num] = {};
						scores_pruned[result_num].id=score[g].id;
						scores_pruned[result_num].num=score[g].num;
			//			scores_pruned[result_num].num_words= get_word_tot(scores_pruned[result_num].id);
						scores_pruned[result_num].num_words= word_tot[scores_pruned[result_num].id];
						scores_pruned[result_num].jaccard = 1-(score[g].num/(scores_pruned[result_num].num_words+wds_in_q-scores_pruned[result_num].num));
						result_num++;
					}
				}				
				if(result_num <= 1) {
					document.getElementById("messages").innerHTML = "No results! Try a new search!";
					hide_result_table();
					return;
				}
				
				show_result_table();
			
				var table_html = "";
				table_html = "<thead><tr><th colspan='2'><small>"+num_res_disp+" best</small></th> <th><small>Relation to query</small></th> </tr></thead>";
				table_html += "<tbody class='table_body'>";
				
				var db =  document.getElementById("maw_data").value;

				// rank pruned results
				if(jaccard) scores_pruned.sort(function(a, b){return a.jaccard-b.jaccard}); // Ascending, as 0 is identity match
				else scores_pruned.sort(function(a, b){return b.num-a.num}); // Descending

				last_res_disp = 0;
				for(q=0;q<=num_res_disp;q++) if(q<scores_pruned.length) {
				
				// for Jaccard distance
					if(jaccard) var rank_factor = scores_pruned[q].jaccard;
				// for basic search
					else var rank_factor = scores_pruned[q].num / scores_pruned[0].num;
					
					var result_row_id = "result_row"+q;
					var target_id = scores_pruned[q].id;
					var sim_choice_id = "sim_choice"+q;
					var sim_id = "sim"+q;

					if(scores_pruned[q].id == query_id)   {
						table_html +=
							"<tr class='id_list_name' id='"+result_row_id
							+"' onclick='load_result_image(\""+target_id+"\","+q+","+(rank_factor*100).toFixed(1)+");'>"
								+"<td text-align='center' style='color:blue'><small>" +target_id+"</small></td>"
					//			+"<td style='border-left:"+(rank_factor*100).toFixed(2)+"px solid red' width='160px' height='10px' ></td>"
								+"<td style='border-left:"+(rank_factor*100).toFixed(2)+"px solid red'  ></td>"
								+"<td width='160px' id='"+sim_choice_id+"'>"
									+"<select class='drop_downs' "
										+"onchange='log_user_choice(\""+query_id+"\",\""
											+target_id+"\","
											+q+", \""
											+db_name+"\");'"
										+" id='"+sim_id+"'>"
									//	+"<span>"
											+"<option selected' value='0'></option>"
											+"<option value='notm'>Not music!</option>"
									//	+"</span>"
									+"</select>"
							
								+"</td>"+"</tr>";
					}
					else {
						table_html +=
							"<tr class='id_list_name' id='"+result_row_id
							+"' onclick='load_result_image(\""+target_id+"\","+q+","+(rank_factor*100).toFixed(1)+");'>"
								+"<td text-align='center' style='color:blue'><small>" +target_id+"</small></td>"
					//			+"<td style='border-left:"+(rank_factor*100).toFixed(2)+"px solid red' width='160px' height='10px' ></td>"
								+"<td style='border-left:"+(rank_factor*100).toFixed(2)+"px solid red' ></td>"
								+ "<td id='"+sim_choice_id+"'>"
		/**/
									+"<select  class='drop_downs'"
										+"onchange='log_user_choice(\""+query_id+"\",\""
											+target_id+"\","
											+q+", "
											+"\""+db_name+"\");'"
										+" id='"+sim_id+"'>"
								//		+"<span class='drop_downs'>"
											+"<option selected' value='0'></option>"
											+"<option value='dupl'>Duplicate page</option>"
											+"<option value='same'>Same music</option>"
											+"<option value='relv'>Related music</option>"
											+"<option value='notm'>Not music!</option>"
								//		+"</span>"
									+"</select>"
		
								+"</td>"+"</tr>";
						last_res_disp++;
						}
				}
				table_html += "</tbody>";
				document.getElementById('result_table').innerHTML = table_html;
				load_result_image(query_id, 0, 100);
				show_result_image();
			}
		
			// For timing searches:
			function do_search(complete) {
					var t0 = performance.now();
					searchTrie(complete);
					var t1 = performance.now();
					var report_string = 'Search '+query_id+' ('+wds_in_q+' words) took ' + (t1 - t0).toFixed(4) + ' ms ';
					report_string += document.getElementById('rank_toggle').innerText;
					console.log(report_string);
				
			}

			function load_page_query(id) {
				image= id + ".jpg";
				document.getElementById("q_page_display").innerHTML = "  Current page: "+image;
				document.getElementById("img_display").innerHTML = "<img width = '400px' src='http://doc.gold.ac.uk/~mas01tc/page_dir/"+image+"' />";
				$('#img_display').zoom();		
//				load_lyrics(id, true);

				show_query_display();
				hide_result_table();
				hide_result_image();
			}			
			function get_query_from_id(id) {
	//			console.log("Looking for id "+id+" in "+lines.length+" lines of database");
				for(var i=0;i<lines.length;i++) {
					if((lines[i].startsWith(">"+id))||(lines[i].startsWith(id))) return lines[i];
				}
				return false
			}
			
			function show_database_panel() {
				document.getElementById("database_panel").style.visibility = "visible";
			}		
			function hide_database_panel() {
				document.getElementById("database_panel").style.visibility = "hidden";
			}
			function show_query_panel() {
				document.getElementById("query_panel").style.visibility = "visible";
			}		
			function hide_query_panel() {
				document.getElementById("query_panel").style.visibility = "hidden";
			}
			function show_display_panel() {
				document.getElementById("display_panel").style.visibility = "visible";
			}
			function hide_display_panel() {
				document.getElementById("display_panel").style.visibility = "hidden";
			}
			function show_query_display() {
				document.getElementById("query_display").style.visibility = "visible";
			}
			function hide_query_display() {
				document.getElementById("query_display").style.visibility = "hidden";
			}
			function show_result_table() {
				document.getElementById("res_table_label").innerHTML = "Results";
				document.getElementById("res_table_div").innerHTML = '<table id="result_table" text-align="center" width="200" border="1px"></table>';
				document.getElementById("res_table_label").style.visibility = "visible";
				document.getElementById("res_table_div").style.visibility = "visible";
			}
			function hide_result_table() {
				document.getElementById("res_table_label").style.visibility = "hidden";
				document.getElementById("res_table_div").style.visibility = "hidden";
			}
							
			function highlight_result_row(rank) {
				var rowID = "";
				for(var i=0;i<last_res_disp;i++) {
					rowID = "result_row"+i;
					document.getElementById(rowID).style.backgroundColor = "White";
				}
				rowID = "result_row"+rank;
				document.getElementById(rowID).style.backgroundColor = "LightPink";
				highlighted_result_row = rank;
			}
			function load_result_image(id, rank, percent) {
				if(!id) {
					document.getElementById("result_id_msg").innerHTML = "";
					document.getElementById("result_img_display").innerHTML = "";
					return false;
				}
				image= id + ".jpg";
				if(query_id != id) document.getElementById("result_id_msg").innerHTML = "Rank: "+rank+"("+percent+"%) "+image;
				else document.getElementById("result_id_msg").innerHTML = "Query: "+image;
				document.getElementById("result_img_display").innerHTML = "<img width = '400px' src='http://doc.gold.ac.uk/~mas01tc/page_dir/"+image+"' />";
				highlight_result_row(rank);
				$('#result_img_display').zoom();			
				document.getElementById("idText").value = id;
//				load_lyrics(id, false);
			}		
			function hide_result_image() {
				document.getElementById("res_display_div").style.visibility = "hidden";
			}
			function show_result_image() {
				document.getElementById("res_display_div").style.visibility = "visible";
			}
			
		/*If there exists a set of lyric-syllables recognised by Tesseract for this id,
		display it in the appropriate place*/	
			function load_lyrics(our_id, is_query) {
				if(our_id.charAt(0)==">") our_id = our_id.substring(1);
				var display_div_id = is_query? "q_text_display" : "t_text_display";
				document.getElementById(display_div_id).innerHTML = our_id+" Lyrics here!"
				$.ajax({
					type: "GET",
					url: "get_lyrics.php",
					data: {lid: our_id},
					success: function(data) {
						load_data(data);
						document.getElementById(display_div_id).innerHTML = "<small>"+data+"</small>";
					}
				});
				
			}
			
	/*********** Utility functions: ***********/			
			function storageAvailable(type) {
				try {
					var storage = window[type],
						x = '__storage_test__';
					storage.setItem(x, x);
					storage.removeItem(x);
					return true;
				}
				catch(e) {
					return e instanceof DOMException && (
						// everything except Firefox
						e.code === 22 ||
						// Firefox
						e.code === 1014 ||
						// test name field too, because code might not be present
						// everything except Firefox
						e.name === 'QuotaExceededError' ||
						// Firefox
						e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
						// acknowledge QuotaExceededError only if there's something already stored
						storage.length !== 0;
				}
			}
			function getFormattedDate() {
				var date = new Date();
				var month = date.getMonth() + 1;
				var day = date.getDate();
				var hour = date.getHours();
				var min = date.getMinutes();
				var sec = date.getSeconds();
				month = (month < 10 ? "0" : "") + month;
				day = (day < 10 ? "0" : "") + day;
				hour = (hour < 10 ? "0" : "") + hour;
				min = (min < 10 ? "0" : "") + min;
				sec = (sec < 10 ? "0" : "") + sec;
				var str = date.getFullYear() + "-" + month + "-" + day + "_" +  hour + ":" + min + ":" + sec;
				return str;
			}
			function log_user_choice(query_id,target_id,result_num,database) {
				var the_time = getFormattedDate();
				var sim_id="sim"+result_num;
				var sim_choice = document.getElementById(sim_id).value;
				var reportString = the_time+"\t";
				if(can_store_UID) {
					reportString += localStorage.getItem("userID");
				}
				else {
					reportString += UID;
				}
				reportString += "\t" 
							+query_id + "\t" 
							+target_id + "\t" 
							+sim_choice + "\t"
							+ database + "\t"
							+ 'rank: ' + result_num + ": " + document.getElementById('rank_toggle').innerText;
				$.ajax({
					type: "POST",
					url: "log_user_interaction.php",
					data: {reportString: reportString},
					dataType:'TEXT', 
					success: function(response){
						console.log("PHP received: "+response);
						// put on console what server sent back...
					}
				});
			}
			function log_search_problem(query_id,message,database) {
				var the_time = getFormattedDate();
				var reportString = the_time+"\t";
				if(can_store_UID) {
					reportString += localStorage.getItem("userID");
				}
				else {
					reportString += UID;
				}
				reportString += "\t" +query_id+"\t" + database+"\t" + message;
				$.ajax({
					type: "POST",
					url: "log_search_problem.php",
					data: {reportString: reportString},
					dataType:'TEXT', 
					success: function(response){
						console.log("PHP received: "+response);
						// put on console what server sent back...
					}
				});
			}
			function getRandomIntInclusive(min, max) {
			  min = Math.ceil(min);
			  max = Math.floor(max);
			  return Math.floor(Math.random() * (max - min + 1)) + min; 
			}
		// From: https://gist.github.com/gordonbrander/2230317
			function uniqueID(){
			  function chr4(){
				return Math.random().toString(16).slice(-4);
			  }
			  return chr4() + chr4() +
				'-' + chr4() +
				'-' + chr4() +
				'-' + chr4() +
				'-' + chr4() + chr4() + chr4();
			}
		// NOTE: This format of 8 chars, followed by 3 groups of 4 chars, followed by 12 chars
		//       is known as a UUID and is defined in RFC4122 and is a standard for generating unique IDs.
		//       This function DOES NOT implement this standard. It simply outputs a string
		//       that looks similar. The standard is found here: https://www.ietf.org/rfc/rfc4122.txt

			function checkKey(e) {
				e = e || window.event;
				if([37, 38, 39, 40].indexOf(e.keyCode) > -1) {
					e.preventDefault();
				}
				if (e.keyCode == '38') {	// up arrow
					if(highlighted_result_row>0) {
						var targetID="result_row"+(highlighted_result_row-1);
						document.getElementById(targetID).click();
					}
				}
				else if (e.keyCode == '40') {	// down arrow
					if(highlighted_result_row<last_res_disp) {
						var targetID="result_row"+(highlighted_result_row+1);
						document.getElementById(targetID).click();
					}
				}
				else if (e.keyCode == '37') {	// left arrow - repeat last search
					if(last_query_id.length) {
						document.getElementById("idText").value = last_query_id;
						document.getElementById("id_searchButton").click();						
					}
				}
				else if (e.keyCode == '39') {	// right arrow - Search next page
					find_page_id(true);
					do_search(false);
				}
				else if (e.ctrlKey && (e.keyCode == '79')) {
					console.log("Control + O pressed");
			//		load_arbitrary_database();
					load_full_maws_database();
				}
			}
			
			//Global:
			var dl_text =  "";
            function PreviewText() {
				var oFReader = new FileReader();
				oFReader.readAsText(document.getElementById("uploadText").files[0]);
				oFReader.onload = function (oFREvent) {
					dl_text = document.getElementById("uploadTextValue").value = oFREvent.target.result; 
					// We now have it so can delete the hidden input value
					document.getElementById("uploadTextValue").value = "";
				};
			};

			$(document).ready(function(){
				$('#img_display').zoom();
				$('#result_img_display').zoom();
				
				$('#viewSource').click(function ()
				{
					load_data(dl_text);	
				});
				$('#searchButton').click(function ()
				{
					do_search(true);
				});
				$('#id_searchButton').click(function ()
				{
					do_search(false);	
				});
				$('#random_searchButton').click(function ()
				{
					document.getElementById("queryText").value = lines[getRandomIntInclusive(0, lines.length)];
					do_search(true);
				});
			});

			function find_book_id(next) {
				var this_id = document.getElementById("idText").value;
				if(this_id == null) return false;
				else {
					for(var i=0;i<lines.length;i++) {
						if((lines[i].startsWith(">"+this_id))||(lines[i].startsWith(this_id))) {
							break;
						}
					}
					if(((i==0)&&(!next))||((i==lines.length)&&(next))) return;
				// now find next/prev item starting with a different id															
					var this_book = "";
					var id_segs =  this_id.split("_");
					for(j=0;j<id_segs.length-3;j++) this_book+=id_segs[j]+"_";
					this_book+=id_segs[j];
					var new_id = "";
					var new_book = "";
					if(next) {
						for(;i<lines.length;i++) {
							new_book = "";
							new_id = lines[i].split(/[ ,]+/).filter(Boolean)[0];
							id_segs =  new_id.split("_");
							for(j=0;j<id_segs.length-3;j++) new_book+=id_segs[j]+"_";
							new_book+=id_segs[j];
							if(new_book.startsWith(">")) new_book = new_book.substring(1);
							if(new_book != this_book) {
								break;
							}
						}
					}
					else {
						for(;i>0;i--) {
							// FIXME - stand by for messy recursion!!
							new_book = "";
							new_id = lines[i].split(/[ ,]+/).filter(Boolean)[0];
							id_segs =  new_id.split("_");
							for(j=0;j<id_segs.length-3;j++) new_book+=id_segs[j]+"_";
							new_book+=id_segs[j];
							if(new_book.startsWith(">")) new_book = new_book.substring(1);
							if(new_book != this_book) {
								// now we are at last image of the previous book, 
								// so find the book before that one
								// and go to next image - it will be the first of the book we want!
								this_book = new_book;
								for(;i>0;i--) {
									new_book = "";
									new_id = lines[i].split(/[ ,]+/).filter(Boolean)[0];
									id_segs =  new_id.split("_");
									for(j=0;j<id_segs.length-3;j++) new_book+=id_segs[j]+"_";
									new_book+=id_segs[j];
									if(new_book.startsWith(">")) new_book = new_book.substring(1);
									if(new_book != this_book) {
										if(i>0) i++; //Don't go to next if at first
										new_id = lines[i].split(/[ ,]+/).filter(Boolean)[0];									
										break;
									}
								}								
								break;
							}
						}
					}
				}
				new_id = lines[i].split(/[ ,]+/).filter(Boolean)[0];
				if(new_id.startsWith(">")) new_id = new_id.substring(1);
				document.getElementById("idText").value = new_id;
			
				load_page_query(new_id);
			}

			function find_page_id(next) {
				var this_id = document.getElementById("idText").value;
				if(this_id == null) return false;
				else {
					for(var i=0;i<lines.length;i++) {
						if((lines[i].startsWith(">"+this_id))||(lines[i].startsWith(this_id))) {
							break;
						}
					}
					if(((i==0)&&(!next))||((i==lines.length)&&(next))) return;
					var new_id = "";
					if(next) {
						new_id = lines[i+1].split(/[ ,]+/).filter(Boolean)[0];
					}
					else {
						new_id = lines[i-1].split(/[ ,]+/).filter(Boolean)[0];
					}
				}
				if(new_id.startsWith(">")) new_id = new_id.substring(1);
				document.getElementById("idText").value = new_id;
			
				load_page_query(new_id)
			}
			
			function switch_rank() {
				if(jaccard) {
					document.getElementById("rank_toggle").innerHTML = "Basic";
					jaccard = false;
				}
				else {
					document.getElementById("rank_toggle").innerHTML = "Jaccard distance";
					jaccard = true;					
				}
				do_search(false);
			}
			
			function initialise() {
				hide_database_panel();
				hide_query_panel();
				hide_display_panel();
				load_full_maws_database();
				document.getElementById("rank_toggle").innerHTML = (jaccard)? "Basic" : "Jaccard distance";
			}
		
		</script>
	</head>

<!--	<body onload="hide_database_panel();hide_query_panel();hide_display_panel();load_full_maws_database();">		-->
	<body onload="initialise();">		
		
		<script  type="text/javascript" >
			document.onkeydown = checkKey;
		</script>

		<span id="database_panel">
			<b>Load new database:</b>&nbsp;&#160;&#160;
			Choose ngram length: 
			<select id="maw_data" name="database">
				<option value="emo_maw_3sameline.txt">3</option>
				<option value="emo_maw_4sameline.txt">4</option>
				<option value="emo_maw_5sameline.txt">5</option>
				<option value="emo_maw_6sameline.txt" selected>6</option>
				<option value="emo_maw_7sameline.txt">7</option>
				<option value="emo_maw_8sameline.txt">8</option>
				<option value="emo_maw_9sameline.txt">9</option>
				<option value="emo_maw_10sameline.txt">10</option>
				<option value="emo_maw_11sameline.txt">11</option>
				<option value="emo_maw_12sameline.txt">12</option>
				<option value="emo_maw_13sameline.txt">13</option>
				<option value="emo_maw_14sameline.txt">14</option>
				<option value="emo_maw_15sameline.txt">15</option>
			</select>
			<button onclick="get_and_load_database(false);" >Fetch database</button>
		</span>
		<span id="database_name"></span>
		
		<div id="query_panel">
			<hr>
			<span style="display:none">
				Paste query here: <textArea id="queryText" name="query" height="20px" width="600px"></textArea> 
				<button id="searchButton" >Search</button>
				&nbsp;&#160;&#160;
			</span>
	
			<span>
				
				<b>Search: </b>
			<!--	Enter page-id here: -->
				&nbsp;&#160;&#160;
				&nbsp;&#160;&#160;
				<span class="tooltip">
					<img height="15px" onclick="find_book_id(false);do_search(false);" src="prev_book.png"></img>
					<span class="tooltiptext">Go to prev book and search</span>
				</span>
				<span class="tooltip">
					<img height="15px" onclick="find_page_id(false);do_search(false);" src="prev_page.png"></img>
					<span class="tooltiptext">Search for prev page</span>
				</span>
					<textArea onchange="show_query_display();" id="idText"></textArea>
				<span class="tooltip">
					<button id="id_searchButton" >Go</button>
					<span class="tooltiptext">Search for current page</span>
				</span>
				<span class="tooltip">
					<img height="15px" onclick="find_page_id(true);do_search(false);" src="next_page.png"></img>
					<span class="tooltiptext">Search for next page</span>
				</span>
				<span class="tooltip">
					<img height="15px" onclick="find_book_id(true);do_search(false);" src="next_book.png"></img>
					<span class="tooltiptext">Go to next book and search</span>
				</span>
				&nbsp;&#160;&#160;
			</span>
	
			Do a random search: 
			<button id="random_searchButton" >Search</button><!-- <br><br> -->
			&nbsp;&#160;&#160;	
			<span id="messages"></span>
			<span>
				&nbsp;&nbsp;Result ranking:&nbsp;&nbsp;
				<button id='rank_toggle' onclick='switch_rank();'></button>
			</span>
			<hr>
		</div>
	
		<div id="display_panel" style='display: flex; justify-content: left;text-align: center;'>
		<!--		<div width='300px' style=' overflow-y: auto;' > -->
				<div width='300px' >
					<div id="query_display">
						<span class="tooltip">
							<img height="15px" onclick="find_book_id(false);" src="prev_book.png"></img>
							<span class="tooltiptext">Show first page of prev book</span>
						</span>
						<span class="tooltip">
							<img height="15px" onclick="find_page_id(false);" src="prev_page.png"></img>
							<span class="tooltiptext">Show prev page</span>
						</span>
						<span style="color:green" id="q_page_display"></span>
						<span class="tooltip">
							<img height="15px" onclick="find_page_id(true);" src="next_page.png"></img>
							<span class="tooltiptext">Show next page</span>
						</span>
						<span class="tooltip">
							<img height="15px" onclick="find_book_id(true);" src="next_book.png"></img>
							<span class="tooltiptext">Show first page of next book</span>
						</span>
					</div>
					<div id="img_display"></div>
					<div id="q_text_display"></div>
				</div>
				&nbsp;&#160;&#160;
				<div>
					<span id="res_table_label" height='24px' ></span>
					<div id="res_table_div"></div>
				</div>
				&nbsp;&#160;&#160;
	<!--			<div id="res_display_div" width='300px' style=' overflow-y: auto;'> -->
				<div id="res_display_div" width='300px'>
					<div style="color:red" id="result_id_msg"></div>
					<div id="result_img_display"></div>
					<div id="t_text_display"></div>
				</div>
		</div>
	
	</body>
</html>